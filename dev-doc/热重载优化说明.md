# 热重载优化说明

## 概述

为了避免编译输出和日志目录触发热重载，导致不必要的重复编译，我们对开发环境进行了全面优化。

## 优化内容

### 1. 后端 Rust 热重载优化

#### 文件位置
- `scripts/dev/start_backend_dev_optimized.sh`
- `backend/.cargo-watch.toml` (自动生成)

#### 排除的目录和文件
```bash
# 编译输出目录
target/**
dist/**
build/**

# 日志和临时文件
logs/**
*.log
*.pid
*.tmp
*.swp
*.swo
*.orig
*.rej

# 依赖和缓存目录
node_modules/**
.angular/**
coverage/**
e2e/**

# 版本控制
.git/**

# Rust 编译产物
**/*.rlib
**/*.rmeta
**/*.d
**/*.pdb
**/*.ilk
**/*.exp
**/*.lib
**/*.a
**/*.so
**/*.dylib
**/*.dll
**/*.exe
**/*.map
```

#### 优化特性
- 预编译依赖，避免重复编译第三方库
- 1秒延迟，防止快速连续修改触发多次编译
- 只监听源代码文件 (`src/` 和 `Cargo.toml`)
- 增量编译，提高编译速度

### 2. 前端 Angular 热重载优化

#### 文件位置
- `frontend/angular.json` (serve 配置)
- `frontend/package.json` (启动脚本)

#### 优化配置
```json
{
  "serve": {
    "builder": "@angular-devkit/build-angular:dev-server",
    "options": {
      "browserTarget": "starrocks-admin:build",
      "poll": 2000
    }
  }
}
```

#### 优化特性
- **2秒轮询间隔** (`poll: 2000`)，减少文件系统监听压力，适用于某些文件系统（如 WSL、网络文件系统）
- **自动排除编译输出**：Angular CLI 通过 webpack 自动排除 `node_modules/`、`dist/`、`.angular/`、`coverage/` 等目录
- **只监听源代码**：默认只监听 `src/` 目录下的文件变化
- **智能热更新**：Angular CLI 内置的 HMR (Hot Module Replacement) 功能只重新编译修改的模块

### 3. .gitignore 优化

#### 文件位置
- `.gitignore`

#### 新增的排除规则
```gitignore
# Rust build artifacts and logs
**/target/
**/*.rlib
**/*.rmeta
**/*.d
**/*.pdb
**/*.ilk
**/*.exp
**/*.lib
**/*.a
**/*.so
**/*.dylib
**/*.dll
**/*.exe
**/*.pdb
**/*.map
**/*.log
**/*.pid
**/*.tmp
**/*.swp
**/*.swo
**/*.orig
**/*.rej

# Angular build artifacts
**/dist/
**/build/
**/.angular/
**/coverage/
**/e2e/
**/*.spec.ts
**/*.spec.js
**/*.spec.js.map
```

## 使用方法

### 启动优化的开发环境

```bash
# 使用优化的开发环境（推荐）
bash scripts/dev/start_dev_optimized.sh dev

# 或者分别启动
bash scripts/dev/start_backend_dev_optimized.sh
bash scripts/dev/start_frontend.sh start
```

### 验证优化效果

1. **检查后端热重载**：
   - 修改 `backend/src/` 下的任何 `.rs` 文件
   - 应该只触发一次重新编译
   - 不会因为 `target/` 或 `logs/` 目录的变化而重新编译

2. **检查前端热重载**：
   - 修改 `frontend/src/` 下的任何文件
   - 应该只触发一次重新编译
   - 不会因为 `dist/` 或 `.angular/` 目录的变化而重新编译

## 性能提升

### 编译速度提升
- **首次编译**：预编译依赖，避免重复编译第三方库
- **增量编译**：只编译修改的代码，不重新编译整个项目
- **文件监听优化**：减少监听的文件数量，降低系统资源消耗

### 开发体验提升
- **减少重复编译**：排除编译输出目录，避免循环触发
- **更快的热重载**：优化文件监听，提高响应速度
- **更稳定的开发环境**：减少因文件监听导致的意外重启

## 故障排除

### 如果热重载仍然触发重复编译

1. **检查 cargo-watch 配置**：
   ```bash
   cd backend
   cat .cargo-watch.toml
   ```

2. **检查 Angular 配置**：
   ```bash
   cd frontend
   grep -A 20 "watchOptions" angular.json
   ```

3. **清理编译缓存**：
   ```bash
   # 清理 Rust 编译缓存
   cd backend
   cargo clean
   
   # 清理 Angular 编译缓存
   cd frontend
   rm -rf .angular dist
   ```

### 如果文件修改不触发热重载

1. **检查文件是否在监听范围内**：
   - 后端：只监听 `src/` 和 `Cargo.toml`
   - 前端：只监听 `src/` 目录

2. **检查文件权限**：
   ```bash
   ls -la src/
   ```

3. **重启开发服务器**：
   ```bash
   # 停止所有服务
   bash scripts/dev/stop.sh
   
   # 重新启动
   bash scripts/dev/start_dev_optimized.sh dev
   ```

## 总结

通过以上优化，我们成功解决了编译输出和日志目录触发热重载的问题，显著提升了开发体验和编译效率。开发环境现在更加稳定和高效。

