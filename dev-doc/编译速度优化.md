# Rust 编译速度优化指南

## 当前优化状态

本项目已经启用了多项编译优化，但如果仍然感觉编译速度慢，可以尝试以下进一步优化：

## 已实施的优化

### 1. Cargo 配置优化 (`backend/.cargo/config.toml`)

- ✅ **增量编译**: `incremental = true`
- ✅ **并行编译**: 自动根据 CPU 核心数调整（默认使用 75% 的核心）
- ✅ **代码生成单元**: `codegen-units = 16`（平衡编译速度和优化）
- ✅ **依赖优化**: 第三方库使用 `opt-level = 1`

### 2. 启动脚本优化

- ✅ 自动检测 CPU 核心数
- ✅ 设置 `CARGO_BUILD_JOBS` 环境变量
- ✅ 预编译依赖库（使用 release 模式）

## 进一步优化方案

### 方案 1: 使用 sccache（编译缓存）

`sccache` 是一个分布式编译缓存工具，可以显著加快重复编译的速度。

#### 安装 sccache

```bash
# 在 WSL 中安装
cargo install sccache

# 或者使用包管理器（如果可用）
# sudo apt-get install sccache  # Ubuntu/Debian
```

#### 配置 sccache

在 `~/.bashrc` 或 `~/.zshrc` 中添加：

```bash
export RUSTC_WRAPPER=sccache
```

或者在启动脚本中临时启用：

```bash
export RUSTC_WRAPPER=sccache
cargo build
```

#### 效果

- **首次编译**: 无影响（正常速度）
- **重复编译**: 加速 2-5 倍（取决于缓存命中率）
- **磁盘空间**: 需要额外的缓存空间（通常几百 MB 到几 GB）

### 方案 2: 使用 mold 链接器（更快链接）

`mold` 是一个快速链接器，可以显著加快链接阶段的速度。

#### 安装 mold

```bash
# Ubuntu/Debian
sudo apt-get install mold

# 或从源码编译（最新版本）
git clone https://github.com/rui314/mold.git
cd mold
make -j$(nproc)
sudo make install
```

#### 配置使用 mold

在 `backend/.cargo/config.toml` 中：

```toml
[target.x86_64-unknown-linux-gnu]
linker = "clang"
rustflags = ["-C", "link-arg=-fuse-ld=mold"]
```

#### 效果

- **编译速度**: 链接阶段加速 2-10 倍
- **总体加速**: 依赖项目中链接时间占比（通常 10-30%）
- **兼容性**: 需要 LLVM/Clang 工具链

### 方案 3: 将项目移到 Linux 文件系统

**重要**: 如果你的项目在 `/mnt/d/...`（Windows 文件系统）上，性能会显著下降。

#### 为什么？

- WSL 在 Windows 文件系统上使用 9p 文件系统，性能较差
- 文件 I/O 操作比原生 Linux 文件系统慢 3-10 倍
- 影响增量编译的缓存读写速度

#### 解决方案

将项目复制到 Linux 文件系统（如 `~/workspace`）：

```bash
# 1. 在 WSL 的 Linux 文件系统中创建工作目录
mkdir -p ~/workspace
cd ~/workspace

# 2. 克隆或复制项目
git clone <your-repo-url> starrocks-admin
# 或者
cp -r /mnt/d/Git/Cursor-in-action/go/starrocks-admin ~/workspace/

# 3. 在 Linux 文件系统中开发
cd ~/workspace/starrocks-admin
make dev
```

#### 效果

- **编译速度**: 提升 2-5 倍
- **文件监听**: 更可靠（无需轮询）
- **总体体验**: 显著改善

**注意**: 如果在 Windows 中也需要访问代码，可以使用符号链接：

```bash
# 在 Windows 文件系统中创建符号链接指向 Linux 文件系统
mklink /D D:\Git\starrocks-admin-linux \\wsl$\<distro-name>\home\<user>\workspace\starrocks-admin
```

### 方案 4: 调整编译配置

#### 增加并行任务数

如果你的 CPU 核心数很多，可以手动调整：

```bash
# 临时设置
export CARGO_BUILD_JOBS=12  # 根据你的 CPU 核心数调整

# 或在启动脚本中设置（已自动检测）
```

#### 增加代码生成单元（加快编译，轻微降低优化）

在 `backend/.cargo/config.toml` 中：

```toml
[profile.dev]
codegen-units = 256  # 默认值，最快编译速度
```

**权衡**: 
- ✅ 编译速度最快
- ⚠️ 生成的代码优化较少（但 debug 模式影响不大）

### 方案 5: 使用 nightly Rust（实验性）

Nightly Rust 通常包含最新的性能优化，但可能不稳定。

```bash
# 安装 nightly
rustup install nightly

# 在项目中启用
rustup override set nightly

# 或仅用于编译（推荐）
cargo +nightly build
```

## 性能对比

| 方案 | 首次编译 | 增量编译 | 设置复杂度 | 推荐度 |
|------|---------|---------|-----------|--------|
| 基础优化（当前） | 基准 | 基准 | ⭐ 简单 | ⭐⭐⭐ |
| + sccache | 基准 | 2-5x | ⭐⭐ 中等 | ⭐⭐⭐⭐ |
| + mold | 基准 | 1.1-1.3x | ⭐⭐ 中等 | ⭐⭐⭐ |
| Linux 文件系统 | 2-5x | 2-5x | ⭐⭐⭐ 复杂 | ⭐⭐⭐⭐⭐ |
| 组合优化 | 2-5x | 5-10x | ⭐⭐⭐⭐ 复杂 | ⭐⭐⭐⭐⭐ |

## 推荐配置（最大化性能）

```bash
# 1. 将项目移到 Linux 文件系统
cd ~/workspace/starrocks-admin

# 2. 安装 sccache 和 mold
cargo install sccache
sudo apt-get install mold  # 或从源码编译

# 3. 在 ~/.bashrc 中添加
export RUSTC_WRAPPER=sccache

# 4. 更新 .cargo/config.toml 使用 mold
# （按照方案 2 的配置）

# 5. 启动开发环境
make dev
```

## 监控编译性能

### 查看编译时间

```bash
# 启用编译时间统计
cargo build --timings

# 或使用 cargo-bench 插件
cargo install cargo-bench
cargo bench --no-run  # 仅编译，不运行
```

### 查看 sccache 统计

```bash
sccache --show-stats
```

### 查看缓存大小

```bash
# Cargo 增量编译缓存
du -sh backend/target/debug/incremental/

# sccache 缓存（通常在 ~/.cache/sccache）
du -sh ~/.cache/sccache/
```

## 故障排除

### sccache 不工作

检查环境变量：

```bash
echo $RUSTC_WRAPPER
# 应该显示: sccache
```

### mold 链接失败

确保已安装 mold 且路径正确：

```bash
which mold
ld.lld --version  # mold 可能需要 clang/lld
```

### Linux 文件系统访问问题

如果需要在 Windows 中编辑代码：

1. 使用 VS Code Remote - WSL 扩展
2. 或者使用符号链接（见方案 3）
3. 或者使用 Git 同步到 Windows 目录

## 注意事项

1. **首次编译**: 任何优化方案都无法显著加快首次编译（需要下载和编译所有依赖）
2. **磁盘空间**: sccache 和增量编译需要额外的磁盘空间（通常 1-5 GB）
3. **网络**: 首次下载依赖需要良好的网络连接
4. **CPU**: 并行编译会占用大量 CPU 资源，可能影响其他程序

