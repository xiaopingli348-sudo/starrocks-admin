# 热重载开发指南

## 概述

StarRocks Admin 支持热重载开发模式，代码修改后自动重新编译并重启，无需手动重启服务，大大提升开发效率。

## 快速开始

### 一键启动开发环境

```bash
# 启动热重载开发环境（推荐）
make dev
```

这将启动：
- ✅ 后端服务（支持自动重新编译）
- ✅ 前端服务（Angular 热重载）
- ✅ 实时日志输出

### 后台模式启动

```bash
# 后台启动
make dev-start

# 查看服务状态
make dev-status

# 查看实时日志
make dev-logs

# 停止服务
make dev-stop

# 重启服务
make dev-restart
```

## 功能特性

### 后端热重载

- **自动编译**：修改 Rust 代码后，`cargo-watch` 会自动检测并重新编译
- **即时重启**：编译完成后自动重启服务
- **快速反馈**：编译错误会在终端显示

工作原理：
```bash
# 使用 cargo-watch 监听文件变化
cargo watch -x "run"
```

### 前端热重载

- **Angular Dev Server**：自带热模块替换（HMR）
- **即时预览**：修改 TypeScript/HTML/SCSS 立即生效
- **无需刷新**：保持应用状态不变

## 开发流程

### 1. 启动开发环境

```bash
make dev
```

输出示例：
```
╔════════════════════════════════════════╗
║   StarRocks Admin - Dev Environment   ║
╚════════════════════════════════════════╝

[1/4] Checking environment...
✓ Environment OK

[2/4] Starting backend with hot reload...
✓ Backend running

[3/4] Starting frontend...
[4/4] Services starting...

Development environment started!

Access URLs:
  Frontend: http://localhost:4200
  Backend:  http://localhost:8081
  API Docs: http://localhost:8081/api-docs

✓ Hot reload enabled - code changes auto-reload
Press Ctrl+C to stop all services
```

### 2. 开发调试

修改代码：
- 后端（Rust）：修改任何 `.rs` 文件 → 自动编译并重启
- 前端（Angular）：修改任何 `.ts`/`.html`/`.scss` 文件 → 自动更新

### 3. 查看日志

在另一个终端：
```bash
make dev-logs
```

### 4. 停止服务

```bash
# 方法1：按 Ctrl+C（前台模式）
# 方法2：运行停止命令（后台模式）
make dev-stop
```

## 常用命令

| 命令 | 说明 |
|------|------|
| `make dev` | 启动开发环境（热重载） |
| `make dev-start` | 后台启动开发环境 |
| `make dev-stop` | 停止开发环境 |
| `make dev-restart` | 重启开发环境 |
| `make dev-status` | 查看服务状态 |
| `make dev-logs` | 查看实时日志 |

## 配置说明

### 后端开发配置

配置文件：`backend/conf/config.toml`

开发模式自动配置：
```toml
[server]
host = "0.0.0.0"
port = 8081

[database]
url = "sqlite:///tmp/starrocks-admin.db"

[cors]
allow_origin = "http://0.0.0.0:4200"

[logging]
level = "debug"
```

### 前端开发配置

Angular CLI 自动配置，支持：
- 热模块替换（HMR）
- Source Maps
- TypeScript 检查

## 故障排除

### 端口占用

如果端口已被占用：
```bash
# 停止占用的进程
lsof -ti :8081 | xargs kill -9  # 后端
lsof -ti :4200 | xargs kill -9  # 前端
```

### 依赖问题

重新安装依赖：
```bash
# 前端
cd frontend
rm -rf node_modules
npm install

# 后端（自动处理）
cargo clean
make dev
```

### 编译错误

查看详细错误信息：
```bash
# 后端日志
tail -f backend/logs/starrocks-admin.log

# 前端日志
make dev-logs
```

## 性能优化

### 后端编译优化

开发模式使用 `cargo watch -x "run"`，首次编译较慢，后续增量编译很快。

### 前端构建优化

Angular Dev Server 使用内存编译，非常快速。

## 最佳实践

1. **保持终端打开**：开发过程中保持终端显示日志
2. **检查编译错误**：首次保存后检查是否有编译错误
3. **使用浏览器开发者工具**：配合进行前端调试
4. **利用 API Docs**：访问 `http://localhost:8081/api-docs` 测试 API
5. **定期重启**：如果出现异常，尝试 `make dev-restart`

## 开发技巧

### 快速重启

```bash
# 需要重启时
make dev-restart
```

### 分离终端

启动开发环境时，建议在独立终端运行 `make dev-logs` 查看日志。

### 快速构建

如果需要完整构建：
```bash
make build
```

## 下一步

- [开发环境准备](./开发环境准备.md)
- [后端开发指南](./后端开发.md)
- [前端开发指南](./前端开发.md)
- [API 开发指南](./API开发.md)

